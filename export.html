<!--
Based on: https://github.com/figma/plugin-samples/blob/master/variables-import-export/export.html
-->

<!-- Vue 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<!-- Vue multiselect -->
<script src="https://unpkg.com/vue-multiselect"></script>
<link rel="stylesheet" href="https://unpkg.com/vue-multiselect/dist/vue-multiselect.min.css">

<style type="text/css" scoped>
  :root {
    --spacing: 0.8rem;
  }

  * {
    box-sizing: border-box;
  }

  body {
    background-color: var(--figma-color-bg);
    color: var(--figma-color-text);
    margin: 0;
    padding: var(--spacing);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
      sans-serif;
  }

  html,
  body,
  main {
    height: 100%;
  }

  main {
    display: flex;
    flex-direction: column;
    gap: var(--spacing);
  }

  button {
    appearance: none;
    border-radius: 4px;
    padding: var(--spacing);
  }

  textarea {
    background-color: var(--figma-color-bg-secondary);
    border: 2px solid var(--figma-color-border);
    color: var(--figma-color-text-secondary);
    flex: 1;
    font-family: Andale Mono, monospace;
    font-size: 0.9rem;
    overflow: auto;
    padding: var(--spacing);
    white-space: pre;
  }

  textarea:focus {
    border-color: var(--figma-color-border-selected);
    outline: none;
  }

  button,
  textarea {
    display: block;
    width: 100%;
  }

  button {
    background-color: #05807F;
    cursor: pointer;
    border: none;
    color: var(--figma-color-text-onbrand);
    font-weight: bold;
    cursor: pointer;
  }

  button:disabled {
    background-color: var(--figma-color-bg-disabled);
    color: var(--figma-color-text-disabled);
    cursor: not-allowed;
  }

  #export {
    background-color: var(--figma-color-bg-component);
  }

  #export:hover {
    background-color: green;
  }
</style>

<main id="app">
  <multiselect v-model="value" :options="options" :multiple="true" :close-on-select="false" :clear-on-select="false"
  :preserve-search="true" placeholder="Pick some" :preselect-first="true" disabled="true">
    <template #selection="{ values, search, isOpen }">
      <span
        class="multiselect__single"
        v-if="values.length"
        v-show="!isOpen"
      >
        <!-- {{ values.length }} options selected -->
        All Variables Selected
      </span>
    </template>

  </multiselect>

  <textarea placeholder="Exported variables will render here..." readonly></textarea>


  <button
    v-show="!showDownloadButton"
    id="export"
    type="button" 
    @click="exportJSON"
  > 
    Export Variables
  </button>

  <button 
    v-show="showDownloadButton"
    id="download"
    type="button"
    @click="downloadJSON()"
  > 
    Download
  </button>
</main>

<script>
  const { createApp, ref } = Vue
  
  createApp({
    components: {
        Multiselect: window['vue-multiselect'].default
    },
    setup(props) {
      let tokens = ref({})
      let showDownloadButton = ref(false)

      let value = ref([
        'Primitive colors', 
        'Semantic colors', 
        'Primitive Typography',
        'Semantic Typography',
        'Sizes',
        'Border',
        'Opacity',
        'shadow'
      ])
      let options = ref([
        'Primitive colors', 
        'Semantic colors', 
        'Primitive Typography',
        'Semantic Typography',
        'Sizes',
        'Border',
        'Opacity',
        'shadow'
      ])

      let exportJSON = () => {
        parent.postMessage({ pluginMessage: { type: 'EXPORT' } }, '*')
        showDownloadButton.value = true
      }

      // let downloadJSON = () => {
      //   const mimeType = 'application/json'
      //   const element = document.createElement('a')
      //   element.setAttribute(
      //     'href',
      //     `data:${mimeType};charset=utf-8,` + encodeURIComponent(JSON.stringify(tokens, null, 2)),
      //   )
      //   element.setAttribute('download', 'tokens.json')

      //   element.style.display = 'none'
      //   document.body.appendChild(element)

      //   element.click()

      //   document.body.removeChild(element)
      // }
  
      return {
        tokens,
        showDownloadButton,
        value,
        options,
        exportJSON,
        // downloadJSON
      }
    },
    mounted() {
      let tokens = {}

      window.onmessage = ({ data: { pluginMessage } }) => {
        if (pluginMessage.type === 'EXPORT_RESULT') {
          tokens = pluginMessage.tokens
          document.querySelector('textarea').innerHTML = JSON.stringify(pluginMessage.tokens, null, 2)
        }
      }

      document.getElementById('download').addEventListener('click', async () => {
        const mimeType = 'application/json'
        const element = document.createElement('a')
        element.setAttribute(
          'href',
          `data:${mimeType};charset=utf-8,` + encodeURIComponent(JSON.stringify(tokens, null, 2)),
        )
        element.setAttribute('download', 'tokens.json')

        element.style.display = 'none'
        document.body.appendChild(element)

        element.click()

        document.body.removeChild(element)
      })
    }
  }).mount('#app')
</script>